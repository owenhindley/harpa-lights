//Symbol Ripples Visualiser by FIELD (David Li/Marcus Wendt)

var HarpaVisualiserBase = require("../common/HarpaVisualiserBase.js");

    //////////////////////////////////////////
    //CHANGE THIS TO VARY THE OVERALL SPEED (higher = slower, lower = faster)
    var FRAMES_PER_BEAT = 30;
    /////////////////////////////////////////

    var HEIGHT = 13;
    var WIDTH = 37 + 39; //side is 39, front is 37

    var OVERLAY_FADE = 0.98;
    var VELOCITY_DISSIPATION = 0.99;

    var MIN_VELOCITY_DISSIPATION = 0.95;
    var MAX_VELOCITY_DISSIPATION = 0.995;

    var RIPPLE_FORCE_SCALE = 0.1;
    var RIPPLE_SCALE = 1.0;

    var SYMBOL_POSITIONS = [0, 8, 19, 30, 41, 52, 63]; //possible horizontal positions
    //position index cutoffs for the various sizes (a size can only spawn to the right of the cutoff)
    var LARGE_CUTOFF = 4;
    var MEDIUM_CUTOFF = 3;
    var SMALL_CUTOFF = 0;

    var LEFT_RIGHT_CUTOFF = 4; //index between left and right sections

    var DEFAULT_SYMBOL_COLOR = [400, 400, 400];
    var COLOR_PROBABILITY = 0.5;
    var SYMBOL_COLORS = [
        [73, 118, 232],
        [83, 149, 226],
        //[93, 180, 219],
        [107, 219, 211],
        [118, 246, 206],
        [240, 80, 52],
        [255, 204, 166],
        [180, 125, 237]
        //[200, 200, 400],
    ];

    var RHYTHMS = [
        [1],
        [0.25, 0.25, 0.25, 0.25],
        [0.5, 0.5],
        [1, 1, 0.25, 0.25, 0.25, 0.5, 0.25],
        [0.25, 0.5, 0.25],
        [0.5, 0.25, 0.25, 0.25, 0.25, 0.5],
    ];

    var BIG_SYMBOLS = [
        //O
        [[0,0,0,0.1568627450980392,0.6784313725490196,0.9176470588235294,0.9176470588235294,0.9176470588235294,0.7333333333333334,0.27450980392156865,0,0,0],[0,0,0.4117647058823529,0.9176470588235294,0.7686274509803921,0.4509803921568627,0.30980392156862746,0.4,0.7098039215686274,0.9176470588235294,0.607843137254902,0,0],[0,0.42352941176470593,0.9176470588235294,0.44705882352941173,0,0,0,0,0,0.2705882352941177,0.9176470588235294,0.6509803921568628,0],[0.11372549019607847,0.9176470588235294,0.4509803921568627,0,0,0,0,0,0,0,0.19999999999999996,0.9176470588235294,0.3803921568627451],[0.7176470588235294,0.7960784313725491,0,0,0,0,0,0,0,0,0,0.596078431372549,0.9176470588235294],[0.9176470588235294,0.4156862745098039,0,0,0,0,0,0,0,0,0,0.1725490196078432,0.9058823529411765],[0.9176470588235294,0.27450980392156865,0,0,0,0,0,0,0,0,0,0.0980392156862745,0.788235294117647],[0.9176470588235294,0.34901960784313724,0,0,0,0,0,0,0,0,0,0.1333333333333333,0.8666666666666667],[0.8235294117647058,0.7137254901960784,0,0,0,0,0,0,0,0,0,0.4745098039215686,0.9176470588235294],[0.2313725490196078,0.9176470588235294,0.24705882352941178,0,0,0,0,0,0,0,0.04313725490196074,0.9176470588235294,0.5372549019607843],[0,0.6235294117647059,0.9176470588235294,0.21176470588235297,0,0,0,0,0,0.07450980392156858,0.8705882352941177,0.8352941176470589,0],[0,0,0.6431372549019607,0.9176470588235294,0.5647058823529412,0.2313725490196078,0.12941176470588234,0.196078431372549,0.4745098039215686,0.9176470588235294,0.8431372549019608,0.0862745098039216,0],[0,0,0,0.38431372549019605,0.8352941176470589,0.8588235294117648,0.788235294117647,0.8431372549019608,0.8784313725490196,0.5176470588235293,0,0,0]],
        //R
        //[[0.7411764705882353,0.11764705882352944,0,0.2313725490196078,0.7294117647058824,0.8509803921568627,0.8352941176470589,0.6509803921568628,0.1098039215686275,0],[0.788235294117647,0,0.2313725490196078,0.9176470588235294,0.4392156862745098,0.06666666666666665,0.11372549019607847,0.6274509803921569,0.8862745098039215,0.1098039215686275],[0.7411764705882353,0.1215686274509804,0.7176470588235294,0.34509803921568627,0,0,0,0,0.592156862745098,0.6666666666666667],[0.6941176470588235,0.3921568627450981,0.6509803921568628,0,0,0,0,0,0.20392156862745103,0.7176470588235294],[0.7019607843137254,0.3647058823529412,0.6666666666666667,0,0,0,0,0,0.2313725490196078,0.7215686274509804],[0.7450980392156863,0.07843137254901966,0.7019607843137254,0.44313725490196076,0,0,0,0,0.6745098039215687,0.611764705882353],[0.788235294117647,0.019607843137254943,0.12941176470588234,0.9176470588235294,0.6235294117647059,0.16078431372549018,0.22352941176470587,0.7607843137254902,0.7607843137254902,0.015686274509803977],[0.788235294117647,0.12941176470588234,0,0.17647058823529416,0.7019607843137254,0.5647058823529412,0.611764705882353,0.615686274509804,0.050980392156862786,0],[0.788235294117647,0.12941176470588234,0,0,0,0.2941176470588235,0.207843137254902,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0.3921568627450981,0.9176470588235294,0.18823529411764706,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0.44313725490196076,0.9176470588235294,0.19999999999999996,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0.388235294117647,0.9176470588235294,0.28627450980392155],[0.6784313725490196,0.1098039215686275,0,0,0,0,0,0,0.4156862745098039,0.7215686274509804]],
        //N
        [[0,0.6705882352941177,0.9176470588235294,0.7803921568627451,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.9176470588235294,0.6627450980392157,0],[0,0.7411764705882353,0.388235294117647,0.03137254901960784,0.12941176470588234,0.12941176470588234,0.12941176470588234,0.12941176470588234,0.12941176470588234,0.09411764705882353,0.22745098039215683,0.6352941176470588,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7450980392156863,0.2823529411764706,0,0,0,0,0,0,0,0.11372549019607847,0.6274509803921569,0],[0,0.7215686274509804,0.2705882352941177,0,0,0,0,0,0,0,0.1098039215686275,0.592156862745098,0]],
        //S
        [[0.788235294117647,0.7960784313725491,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.7411764705882353],[0.8941176470588236,0.22745098039215683,0.12941176470588234,0.12941176470588234,0.12941176470588234,0.12941176470588234,0.12941176470588234,0.11764705882352944],[0.788235294117647,0.06274509803921569,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0.03529411764705881],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0.584313725490196],[0.8156862745098039,0.12941176470588234,0,0,0,0,0,0.6627450980392157],[0.9137254901960784,0.14117647058823535,0,0,0,0,0,0.6196078431372549],[0.21568627450980393,0.03529411764705881,0,0,0,0,0,0.6196078431372549],[0,0,0,0,0,0,0,0.6196078431372549],[0,0,0,0,0,0,0,0.615686274509804],[0,0,0,0,0,0,0,0.6549019607843137],[0.5882352941176471,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.7254901960784313]],
        //A
        //[[0,0,0.4117647058823529,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.788235294117647,0.7764705882352941],[0,0,0.04705882352941182,0.015686274509803977,0,0,0,0.04313725490196074,0.1215686274509804,0.12941176470588234,0.12941176470588234,0.12941176470588234,0.6862745098039216],[0,0,0,0.196078431372549,0.44313725490196076,0.5058823529411764,0.4,0.09411764705882353,0,0,0,0,0.596078431372549],[0,0.04313725490196074,0.6862745098039216,0.7333333333333334,0.5333333333333333,0.4980392156862745,0.5882352941176471,0.7450980392156863,0.5098039215686274,0,0,0,0.6196078431372549],[0,0.788235294117647,0.7098039215686274,0,0,0,0,0.11764705882352944,0.9176470588235294,0.5686274509803921,0,0,0.6196078431372549],[0.4549019607843138,0.7450980392156863,0,0,0,0,0,0,0.03529411764705881,0.8823529411764706,0.21568627450980393,0,0.6196078431372549],[0.7411764705882353,0.2588235294117647,0,0,0,0,0,0,0,0.5058823529411764,0.615686274509804,0,0.6196078431372549],[0.8352941176470589,0.09019607843137256,0,0,0,0,0,0,0,0.38431372549019605,0.6705882352941177,0,0.611764705882353],[0.803921568627451,0.1215686274509804,0,0,0,0,0,0,0,0.403921568627451,0.6745098039215687,0,0.615686274509804],[0.7019607843137254,0.4274509803921569,0,0,0,0,0,0,0,0.6509803921568628,0.4784313725490196,0,0.6196078431372549],[0.2313725490196078,0.9176470588235294,0.14509803921568631,0,0,0,0,0,0.3647058823529412,0.9137254901960784,0.050980392156862786,0,0.6196078431372549],[0,0.5058823529411764,0.9058823529411765,0.3803921568627451,0.07450980392156858,0,0.13725490196078427,0.48235294117647054,0.9176470588235294,0.28627450980392155,0,0,0.6627450980392157],[0,0,0.2941176470588235,0.6980392156862745,0.6784313725490196,0.6196078431372549,0.7019607843137254,0.6549019607843137,0.1568627450980392,0,0,0,0.584313725490196]],
        //L
        [[0.7411764705882353,0.11764705882352944,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.788235294117647,0.12941176470588234,0,0,0,0,0,0,0,0,0],[0.7764705882352941,0.6862745098039216,0.596078431372549,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.6196078431372549,0.6627450980392157,0.584313725490196]],
        //T
        [[0,0.36078431372549025,0.42352941176470593,0],[0,0.403921568627451,0.4745098039215686,0],[0,0.2941176470588235,0.3803921568627451,0],[0.42352941176470593,0.6352941176470588,0.6666666666666667,0.42352941176470593],[0.36078431372549025,0.592156862745098,0.6352941176470588,0.36078431372549025],[0,0.29803921568627456,0.38431372549019605,0],[0,0.3803921568627451,0.44313725490196076,0],[0,0.3803921568627451,0.44313725490196076,0],[0,0.3803921568627451,0.44313725490196076,0],[0,0.3803921568627451,0.44313725490196076,0],[0,0.3803921568627451,0.44313725490196076,0],[0,0.403921568627451,0.4745098039215686,0],[0,0.36078431372549025,0.42352941176470593,0]],
        //triangle
        [[0.8549019607843137,0.8313725490196078,0.8,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8941176470588236,0.7254901960784313],[0.5372549019607843,0.8980392156862745,0.3803921568627451,0.22352941176470587,0.2588235294117647,0.2588235294117647,0.2588235294117647,0.2588235294117647,0.4666666666666667,0.8980392156862745],[0,0.6862745098039216,0.7176470588235294,0,0,0,0,0,0.17647058823529416,0.8980392156862745],[0,0.03137254901960784,0.8980392156862745,0.6392156862745098,0,0,0,0,0.2549019607843137,0.8980392156862745],[0,0,0.19999999999999996,0.8980392156862745,0.403921568627451,0,0,0,0.2549019607843137,0.8980392156862745],[0,0,0,0.403921568627451,0.8980392156862745,0.196078431372549,0,0,0.2549019607843137,0.8980392156862745],[0,0,0,0,0.6352941176470588,0.8980392156862745,0.03529411764705881,0,0.26274509803921564,0.8980392156862745],[0,0,0,0,0,0.8509803921568627,0.7019607843137254,0,0.21568627450980393,0.8980392156862745],[0,0,0,0,0,0.1333333333333333,0.8980392156862745,0.39607843137254906,0.0862745098039216,0.8980392156862745],[0,0,0,0,0,0,0.3254901960784313,0.8980392156862745,0.5215686274509803,0.7764705882352941],[0,0,0,0,0,0,0,0.4784313725490196,0.8980392156862745,0.8196078431372549],[0,0,0,0,0,0,0,0,0.7215686274509804,0.8980392156862745],[0,0,0,0,0,0,0,0,0.17647058823529416,0.580392156862745]],
        //squiggle
        [[0,0.19999999999999996,0.6980392156862745],[0,0.34901960784313724,0.7686274509803921],[0.04705882352941182,0.8313725490196078,0.5607843137254902],[0.6980392156862745,0.7137254901960784,0],[0.7529411764705882,0.23529411764705888,0],[0.7764705882352941,0.4627450980392157,0],[0.28627450980392155,0.8980392156862745,0.36078431372549025],[0,0.41960784313725485,0.7764705882352941],[0,0.23529411764705888,0.7490196078431373],[0,0.6,0.7294117647058824],[0.41960784313725485,0.8980392156862745,0.19215686274509802],[0.8196078431372549,0.38431372549019605,0],[0.44313725490196076,0.1215686274509804,0]],
        //triangle fill big
        //[[0.9803921568627451,0.9803921568627451,0.9764705882352941,0.9764705882352941,0.9764705882352941,0.9764705882352941,0.9764705882352941,0.9764705882352941,0.9764705882352941,0.8941176470588236],[0.607843137254902,1,1,1,1,1,1,1,1,1],[0,0.7058823529411764,1,1,1,1,1,1,1,0.9803921568627451],[0,0.03137254901960784,0.9411764705882353,1,1,1,1,1,1,0.9803921568627451],[0,0,0.19999999999999996,1,1,1,1,1,1,0.9803921568627451],[0,0,0,0.40784313725490196,1,1,1,1,1,0.9803921568627451],[0,0,0,0,0.6470588235294117,1,1,1,1,0.9803921568627451],[0,0,0,0,0,0.8627450980392157,1,1,1,0.9803921568627451],[0,0,0,0,0,0.11764705882352944,0.9921568627450981,1,1,0.9803921568627451],[0,0,0,0,0,0,0.3137254901960784,1,1,0.9764705882352941],[0,0,0,0,0,0,0,0.5333333333333333,1,0.9843137254901961],[0,0,0,0,0,0,0,0,0.8666666666666667,1],[0,0,0,0,0,0,0,0,0.19999999999999996,0.6784313725490196]],
        //o fill big
        //[[0,0,0,0.16470588235294115,0.6352941176470588,0.9137254901960784,0.9803921568627451,0.9529411764705882,0.6941176470588235,0.2823529411764706,0,0,0],[0,0,0.4392156862745098,1,1,1,1,1,1,1,0.6352941176470588,0,0],[0,0.43529411764705883,1,1,1,1,1,1,1,1,1,0.6823529411764706,0],[0.12941176470588234,1,1,1,1,1,1,1,1,1,1,1,0.3686274509803922],[0.6705882352941177,1,1,1,1,1,1,1,1,1,1,1,0.8823529411764706],[0.9686274509803922,1,1,1,1,1,1,1,1,1,1,1,0.9803921568627451],[0.9921568627450981,1,1,1,1,1,1,1,1,1,1,1,0.9843137254901961],[0.9803921568627451,1,1,1,1,1,1,1,1,1,1,1,0.9803921568627451],[0.7333333333333334,1,1,1,1,1,1,1,1,1,1,1,0.9333333333333333],[0.2313725490196078,1,1,1,1,1,1,1,1,1,1,1,0.4980392156862745],[0,0.6431372549019607,1,1,1,1,1,1,1,1,1,0.9019607843137255,0],[0,0,0.6745098039215687,1,1,1,1,1,1,1,0.8666666666666667,0.09019607843137256,0],[0,0,0,0.388235294117647,0.792156862745098,0.9529411764705882,0.9803921568627451,0.9686274509803922,0.8509803921568627,0.5019607843137255,0,0,0]],
        //flat squiggle
        [[0.596078431372549,0.8156862745098039,0.7294117647058824,0.47058823529411764,0.1215686274509804,0,0,0,0,0,0,0,0,0,0,0,0,0.32156862745098036,0.6392156862745098,0.7843137254901961,0.8196078431372549,0.792156862745098,0.6470588235294117,0.32156862745098036,0,0,0,0,0,0,0,0,0,0],[0.8784313725490196,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8196078431372549,0.34901960784313724,0,0,0,0,0,0,0,0,0,0.06274509803921569,0.6549019607843137,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.6235294117647059,0.039215686274509776,0,0,0,0,0,0,0,0],[0.2196078431372549,0.4784313725490196,0.6235294117647059,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.40784313725490196,0,0,0,0,0,0,0,0.09019607843137256,0.6901960784313725,0.8980392156862745,0.8980392156862745,0.7333333333333334,0.49411764705882355,0.4627450980392157,0.4862745098039216,0.7333333333333334,0.8980392156862745,0.8980392156862745,0.6745098039215687,0.09019607843137256,0,0,0,0,0,0,0],[0,0,0,0.3294117647058824,0.8823529411764706,0.8980392156862745,0.8980392156862745,0.5333333333333333,0.1098039215686275,0,0,0,0,0.16470588235294115,0.7058823529411764,0.8980392156862745,0.8980392156862745,0.5647058823529412,0.06666666666666665,0,0,0,0.06666666666666665,0.607843137254902,0.8980392156862745,0.8980392156862745,0.7333333333333334,0.2705882352941177,0.027450980392156876,0,0,0,0,0],[0,0,0,0,0.19215686274509802,0.7294117647058824,0.8980392156862745,0.8980392156862745,0.8156862745098039,0.5568627450980392,0.4627450980392157,0.4627450980392157,0.5607843137254902,0.8627450980392157,0.8980392156862745,0.8980392156862745,0.5450980392156863,0,0,0,0,0,0,0.007843137254901933,0.5607843137254902,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.7019607843137254,0.5411764705882354,0.4784313725490196,0.44705882352941173,0.1568627450980392,0],[0,0,0,0,0,0.0980392156862745,0.6313725490196078,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.4862745098039216,0,0,0,0,0,0,0,0,0,0.42352941176470593,0.8196078431372549,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.8980392156862745,0.7098039215686274,0],[0,0,0,0,0,0,0,0.2549019607843137,0.5372549019607843,0.7333333333333334,0.8196078431372549,0.8196078431372549,0.7411764705882353,0.5176470588235293,0.21568627450980393,0,0,0,0,0,0,0,0,0,0,0,0.1215686274509804,0.388235294117647,0.615686274509804,0.7294117647058824,0.8156862745098039,0.8274509803921568,0.47058823529411764,0]],
    ];

    var MEDIUM_SYMBOLS = [
        //R
        //[[0.36078431372549025,0,0.3803921568627451,0.4392156862745098,0.41960784313725485,0.4509803921568627,0.12941176470588234],[0.3019607843137255,0.2823529411764706,0.43529411764705883,0,0,0.26274509803921564,0.4627450980392157],[0.403921568627451,0.28627450980392155,0.0980392156862745,0,0,0,0.3686274509803922],[0.33333333333333337,0.3529411764705882,0.2588235294117647,0,0,0.09019607843137256,0.45882352941176474],[0.3411764705882353,0.03137254901960784,0.5372549019607843,0.2784313725490196,0.196078431372549,0.5411764705882354,0.27450980392156865],[0.40784313725490196,0,0.10588235294117643,0.403921568627451,0.35686274509803917,0.1215686274509804,0],[0.40784313725490196,0,0,0.05490196078431375,0.3803921568627451,0.07843137254901966,0],[0.40784313725490196,0,0,0,0.22745098039215683,0.5686274509803921,0.12941176470588234],[0.36078431372549025,0,0,0,0,0.22352941176470587,0.4509803921568627]],
        //O
        [[0,0.04705882352941182,0.5372549019607843,0.5764705882352941,0.4980392156862745,0.5607843137254902,0.5686274509803921,0.10196078431372546,0],[0.06274509803921569,0.6862745098039216,0.4980392156862745,0.05490196078431375,0,0.027450980392156876,0.44705882352941173,0.7215686274509804,0.13725490196078427],[0.5098039215686274,0.48235294117647054,0,0,0,0,0,0.3764705882352941,0.596078431372549],[0.5882352941176471,0,0,0,0,0,0,0,0.4901960784313726],[0.4980392156862745,0,0,0,0,0,0,0,0.3921568627450981],[0.5686274509803921,0,0,0,0,0,0,0,0.4745098039215686],[0.5647058823529412,0.4156862745098039,0,0,0,0,0,0.28627450980392155,0.6274509803921569],[0.11764705882352944,0.7176470588235294,0.41960784313725485,0,0,0,0.35686274509803917,0.7372549019607844,0.196078431372549],[0,0.1215686274509804,0.611764705882353,0.49411764705882355,0.4117647058823529,0.4784313725490196,0.6274509803921569,0.1843137254901961,0]],
        //N
        [[0.5333333333333333,0.7450980392156863,0.45882352941176474,0.4980392156862745,0.4980392156862745,0.4980392156862745,0.47058823529411764,0.7215686274509804,0.4980392156862745],[0.5882352941176471,0.5058823529411764,0,0,0,0,0,0.41960784313725485,0.4901960784313726],[0.5882352941176471,0.5058823529411764,0,0,0,0,0,0.41960784313725485,0.4901960784313726],[0.5882352941176471,0.5058823529411764,0,0,0,0,0,0.41960784313725485,0.4901960784313726],[0.5882352941176471,0.5058823529411764,0,0,0,0,0,0.41960784313725485,0.4901960784313726],[0.5882352941176471,0.5058823529411764,0,0,0,0,0,0.41960784313725485,0.4901960784313726],[0.5882352941176471,0.5058823529411764,0,0,0,0,0,0.41960784313725485,0.4901960784313726],[0.5882352941176471,0.5058823529411764,0,0,0,0,0,0.41960784313725485,0.4901960784313726],[0.5568627450980392,0.4862745098039216,0,0,0,0,0,0.4,0.4745098039215686]],
        //S
        [[0.7098039215686274,0.5333333333333333,0.4901960784313726,0.4980392156862745,0.5411764705882354,0.4784313725490196],[0.6196078431372549,0,0,0,0,0],[0.6196078431372549,0,0,0,0,0],[0.6196078431372549,0,0,0,0,0.3176470588235294],[0.6196078431372549,0,0,0,0,0.4980392156862745],[0.4549019607843138,0,0,0,0,0.4980392156862745],[0,0,0,0,0,0.4980392156862745],[0,0,0,0,0,0.4980392156862745],[0.3921568627450981,0.4392156862745098,0.40784313725490196,0.403921568627451,0.40784313725490196,0.6431372549019607]],
        //T
        [[0.019607843137254943,0.3411764705882353,0.05490196078431375],[0.019607843137254943,0.36078431372549025,0.05882352941176472],[0.33725490196078434,0.615686274509804,0.36078431372549025],[0.18039215686274512,0.4745098039215686,0.20392156862745103],[0.019607843137254943,0.36078431372549025,0.05882352941176472],[0.019607843137254943,0.36078431372549025,0.05882352941176472],[0.019607843137254943,0.36078431372549025,0.05882352941176472],[0.019607843137254943,0.36078431372549025,0.05882352941176472],[0.019607843137254943,0.3411764705882353,0.05490196078431375]],
        //L
        [[0.4784313725490196,0,0,0,0,0,0],[0.5411764705882354,0,0,0,0,0,0],[0.4980392156862745,0,0,0,0,0,0],[0.4980392156862745,0,0,0,0,0,0],[0.4980392156862745,0,0,0,0,0,0],[0.4980392156862745,0,0,0,0,0,0],[0.4980392156862745,0,0,0,0,0,0],[0.4980392156862745,0,0,0,0,0,0],[0.6392156862745098,0.40784313725490196,0.40784313725490196,0.40784313725490196,0.40784313725490196,0.40784313725490196,0.3921568627450981]],
        //A
        //[[0,0.13725490196078427,0.4392156862745098,0.388235294117647,0.4,0.4745098039215686,0.4980392156862745,0.4980392156862745,0.6431372549019607],[0,0,0.14117647058823535,0.3137254901960784,0.2588235294117647,0,0,0,0.40784313725490196],[0.015686274509803977,0.49411764705882355,0.5882352941176471,0.4509803921568627,0.4980392156862745,0.6274509803921569,0.16078431372549018,0,0.41960784313725485],[0.4901960784313726,0.584313725490196,0,0,0,0.23921568627450984,0.6666666666666667,0.03529411764705881,0.3686274509803922],[0.6,0,0,0,0,0,0.4745098039215686,0.3058823529411765,0.26274509803921564],[0.4980392156862745,0,0,0,0,0,0.3529411764705882,0.403921568627451,0.24705882352941178],[0.6352941176470588,0.06274509803921569,0,0,0,0,0.5411764705882354,0.2313725490196078,0.2823529411764706],[0.4,0.7058823529411764,0.1098039215686275,0,0,0.41960784313725485,0.6274509803921569,0,0.42352941176470593],[0,0.43137254901960786,0.5882352941176471,0.41960784313725485,0.4784313725490196,0.611764705882353,0.0862745098039216,0,0.4]],
        //squiggle
        [[0,0.4627450980392157],[0.1725490196078432,0.6823529411764706],[0.6705882352941177,0.3686274509803922],[0.6470588235294117,0.02352941176470591],[0.4980392156862745,0.596078431372549],[0,0.5098039215686274],[0.05490196078431375,0.607843137254902],[0.6980392156862745,0.47058823529411764],[0.4549019607843138,0.0039215686274509665]],
        //triangle
        [[0.8392156862745098,0.7215686274509804,0.607843137254902,0.6588235294117647,0.6588235294117647,0.6705882352941177,0.7176470588235294],[0.43137254901960786,0.8823529411764706,0.027450980392156876,0,0.015686274509803977,0.039215686274509776,0.7176470588235294],[0,0.596078431372549,0.6705882352941177,0,0,0,0.6666666666666667],[0,0,0.8,0.4784313725490196,0,0.015686274509803977,0.6705882352941177],[0,0,0.0980392156862745,0.8980392156862745,0.24705882352941178,0,0.6862745098039216],[0,0,0,0.2705882352941177,0.8980392156862745,0.1098039215686275,0.5568627450980392],[0,0,0,0,0.4549019607843138,0.8313725490196078,0.6235294117647059],[0,0,0,0,0,0.6627450980392157,0.8980392156862745],[0,0,0,0,0,0.0039215686274509665,0.5176470588235293]],
        //triangle fill
        [[0.9450980392156862,0.9882352941176471,0.9764705882352941,0.9764705882352941,0.9764705882352941,0.9764705882352941,0.9176470588235294],[0.38431372549019605,1,1,1,1,1,1],[0,0.4980392156862745,1,1,1,1,0.9764705882352941],[0,0,0.7215686274509804,1,1,1,0.9764705882352941],[0,0,0.019607843137254943,0.9490196078431372,1,1,0.9764705882352941],[0,0,0,0.17647058823529416,1,1,0.9725490196078431],[0,0,0,0,0.38431372549019605,1,0.9882352941176471],[0,0,0,0,0,0.6941176470588235,1],[0,0,0,0,0,0,0.607843137254902]],
        //o fill
        //[[0,0,0.44705882352941173,0.7843137254901961,0.9803921568627451,0.8666666666666667,0.5176470588235293,0,0],[0,0.6941176470588235,1,1,1,1,1,0.8509803921568627,0.04313725490196074],[0.43137254901960786,1,1,1,1,1,1,1,0.611764705882353],[0.8941176470588236,1,1,1,1,1,1,1,0.9647058823529412],[1,1,1,1,1,1,1,1,0.9921568627450981],[0.9372549019607843,1,1,1,1,1,1,1,0.9764705882352941],[0.5058823529411764,1,1,1,1,1,1,1,0.6941176470588235],[0.019607843137254943,0.8549019607843137,1,1,1,1,1,0.9686274509803922,0.11764705882352944],[0,0.015686274509803977,0.6,0.9019607843137255,0.9803921568627451,0.9333333333333333,0.6745098039215687,0.11764705882352944,0]],
        //flat squiggle
        [[0.7333333333333334,0.8980392156862745,0.24705882352941178,0,0,0,0,0.6274509803921569,0.8980392156862745,0.8980392156862745,0.6745098039215687,0.015686274509803977,0,0,0],[0.05882352941176472,0.5019607843137255,0.8980392156862745,0.5450980392156863,0.07843137254901966,0.18039215686274512,0.8392156862745098,0.8313725490196078,0.1568627450980392,0.1215686274509804,0.7450980392156863,0.8980392156862745,0.33333333333333337,0.14901960784313728,0.06666666666666665],[0,0,0.22745098039215683,0.8431372549019608,0.8980392156862745,0.8980392156862745,0.6274509803921569,0,0,0,0,0.5019607843137255,0.8980392156862745,0.8980392156862745,0.4509803921568627]],
    ];

    var SMALL_SYMBOLS = [
        //R
        //[[0.22745098039215683,0.207843137254902,0.36078431372549025,0.3686274509803922,0.2313725490196078],[0.48235294117647054,0.24705882352941178,0,0,0.3411764705882353],[0.4980392156862745,0.21568627450980393,0,0,0.30980392156862746],[0.2588235294117647,0.24705882352941178,0.26274509803921564,0.2784313725490196,0.28627450980392155],[0.25098039215686274,0,0.3137254901960784,0.2784313725490196,0],[0.33725490196078434,0,0.04313725490196074,0.35686274509803917,0.1568627450980392],[0.26274509803921564,0,0,0.12941176470588234,0.36078431372549025]],
        //O
        [[0.17647058823529416,0.3803921568627451,0.3294117647058824,0.3803921568627451,0.19999999999999996],[0.3803921568627451,0.09019607843137256,0,0.06666666666666665,0.3803921568627451],[0.2941176470588235,0,0,0,0.22352941176470587],[0.3803921568627451,0.06666666666666665,0,0.04705882352941182,0.3764705882352941],[0.196078431372549,0.3764705882352941,0.2784313725490196,0.3686274509803922,0.2196078431372549]],
        //N
        [[0.403921568627451,0.3529411764705882,0.3019607843137255,0.33725490196078434,0.3647058823529412],[0.35686274509803917,0.007843137254901933,0,0,0.2823529411764706],[0.35686274509803917,0.007843137254901933,0,0,0.2823529411764706],[0.35686274509803917,0.007843137254901933,0,0,0.2823529411764706],[0.33725490196078434,0.007843137254901933,0,0,0.2705882352941177]],
        //S
        [[0.4627450980392157,0.3019607843137255,0.25098039215686274],[0.2784313725490196,0,0],[0.3176470588235294,0,0.24705882352941178],[0,0,0.22352941176470587],[0.19999999999999996,0.2431372549019608,0.4]],
        //T
        //[[0.207843137254902,0.2196078431372549],[0.3647058823529412,0.3764705882352941],[0.22352941176470587,0.23529411764705888],[0.207843137254902,0.2196078431372549],[0.19999999999999996,0.207843137254902]],
        //L
        [[0.2823529411764706,0,0,0],[0.3294117647058824,0,0,0],[0.3019607843137255,0,0,0],[0.27450980392156865,0,0,0],[0.4392156862745098,0.2431372549019608,0.2431372549019608,0.2313725490196078]],
        //A
        //[[0,0.4666666666666667,0.4862745098039216,0.27450980392156865,0.40784313725490196],[0.2313725490196078,0.2784313725490196,0.2588235294117647,0.14509803921568631,0.1725490196078432],[0.3647058823529412,0,0,0.22352941176470587,0.44705882352941173],[0.3647058823529412,0,0,0.22745098039215683,0.4549019607843138],[0.2431372549019608,0.33725490196078434,0.30980392156862746,0.22352941176470587,0.196078431372549]],
        //O fill
        [[0.09411764705882353,0.7058823529411764,0.9647058823529412,0.7294117647058824,0.13725490196078427],[0.7411764705882353,1,1,1,0.8431372549019608],[1,1,1,1,1],[0.792156862745098,1,1,1,0.8980392156862745],[0.12941176470588234,0.7450980392156863,0.9686274509803922,0.792156862745098,0.17647058823529416]],
        //triangle fill
        [[0.7686274509803921,1,0.9803921568627451,0.9372549019607843],[0.1725490196078432,1,1,1],[0,0.21568627450980393,1,1],[0,0,0.5333333333333333,1],[0,0,0,0.5568627450980392]],
    ];

    var positiveMod = function (x, y) {
        return (x % y + y) % y;
    }

    var getData = function (dataArray, x, y, rgbOut) { //gets the rgb from a given x, y in the array
        //for now, let's just repeat
        x = positiveMod(x, WIDTH);
        y = positiveMod(y, HEIGHT);

        var r = dataArray[(y * WIDTH + x) * 3];
        var g = dataArray[(y * WIDTH + x) * 3 + 1];
        var b = dataArray[(y * WIDTH + x) * 3 + 2];

        rgbOut[0] = r;
        rgbOut[1] = g;
        rgbOut[2] = b;

        return rgbOut;
    };

    var setData = function (dataArray, x, y, rgbIn) { //sets the rgb of a given x, y in the array
        var r = rgbIn[0];
        var g = rgbIn[1];
        var b = rgbIn[2];

        dataArray[(y * WIDTH + x) * 3] = r;
        dataArray[(y * WIDTH + x) * 3 + 1] = g;
        dataArray[(y * WIDTH + x) * 3 + 2] = b;
    };

    var setDataWithMax = function (dataArray, x, y, rgbIn) { //sets the rgb using a max() with the current value
        var r = rgbIn[0];
        var g = rgbIn[1];
        var b = rgbIn[2];

        dataArray[(y * WIDTH + x) * 3] = Math.max(r, dataArray[(y * WIDTH + x) * 3]);
        dataArray[(y * WIDTH + x) * 3 + 1] = Math.max(g, dataArray[(y * WIDTH + x) * 3 + 1]);
        dataArray[(y * WIDTH + x) * 3 + 2] = Math.max(b, dataArray[(y * WIDTH + x) * 3 + 2]);
    };

    var addToData = function (dataArray, x, y, rgbIn) {
        var r = rgbIn[0];
        var g = rgbIn[1];
        var b = rgbIn[2];

        dataArray[(y * WIDTH + x) * 3] += r;
        dataArray[(y * WIDTH + x) * 3 + 1] += g;
        dataArray[(y * WIDTH + x) * 3 + 2] += b;
    };

    var rgbToString = function (r, g, b) {
        return 'rgb(' + r.toFixed(0) + ',' + g.toFixed(0) + ',' + b.toFixed(0) + ')';
    };

    var randomItemFromArray = function (array) {
        return array[Math.floor(Math.random() * array.length)];
    };

    var createEmptyArray = function (length) {
        var array = [];
        for (var i = 0; i < length; ++i) {
            array[i] = 0;
        }
        return array;
    }

    var flipSymbolVertically = function (array) {
        var output = [];
        for (var i = 0; i < array.length; ++i) {
            output.push(array[array.length - 1 - i]);
        }
        return output;
    }

    var flipSymbolHorizontally = function (array) {
        var output = [];
        for (var i = 0; i < array.length; ++i) {
            var originalRow = array[i];
            var newRow = [];
            for (var j = 0; j < originalRow.length; ++j) {
                newRow.push(originalRow[originalRow.length - 1- j]);
            }
            output.push(newRow);
        }
        return output;
    }

    var SymbolRipplesVisualiser = function() {
        // stores the current volume
        this.currentVolume = 0;

        // stores the current beat envelope / value
        this.currentBeatValue = 0;

        this.startTimeMillis = Date.now();

        this.overlayDataArray = createEmptyArray(WIDTH * HEIGHT * 3); //data for the overlay
        this.dataArrayU = createEmptyArray(WIDTH * HEIGHT * 3); //2 dimensional array of the rgb u data
        this.tempDataArrayU = createEmptyArray(WIDTH * HEIGHT * 3); //2 dimensional array of the rgb v data
        this.dataArrayV = createEmptyArray(WIDTH * HEIGHT * 3);

        this.currentRhythm = [];
        this.currentRhythmIndex = 0;
        this.framesUntilNextSymbol = 0;

        this.lastSymbolPositionIndex = -1; //remember the last symbol position so we don't put two there in a row
    }

    var p = SymbolRipplesVisualiser.prototype = new HarpaVisualiserBase();   

    p.update = function () {
        var timeMillis = Date.now() - this.startTimeMillis;
        var time = timeMillis / 1000;

        if (this.framesUntilNextSymbol === 0) {
            this.currentRhythmIndex++;
            if (this.currentRhythmIndex < this.currentRhythm.length) { //if there is a next note in the rhythm
                
            } else {
                this.currentRhythm = randomItemFromArray(RHYTHMS);
                this.currentRhythmIndex = 0;
            }

            var noteLength = this.currentRhythm[this.currentRhythmIndex];
            this.framesUntilNextSymbol = Math.floor(noteLength * FRAMES_PER_BEAT);

            var cutoffForSize = 0;
            if (noteLength === 1) {
                cutoffForSize = LARGE_CUTOFF;
            } else if (noteLength === 0.5) {
                cutoffForSize = MEDIUM_CUTOFF;
            } else if (noteLength === 0.25) {
                cutoffForSize = SMALL_CUTOFF;
            }


            var symbolPositionIndex = -2;
            do {
                symbolPositionIndex = Math.floor(Math.random() * SYMBOL_POSITIONS.length)
            } while (symbolPositionIndex === this.lastSymbolPositionIndex || symbolPositionIndex < cutoffForSize);

            this.lastSymbolPositionIndex = symbolPositionIndex;
            var symbolPosition = SYMBOL_POSITIONS[symbolPositionIndex];
            var symbolX = symbolPosition;

            var xOffset = Math.floor(Math.random() * 3);
            symbolX += xOffset;

            var symbolColor = DEFAULT_SYMBOL_COLOR;
            if (Math.random() < COLOR_PROBABILITY) {
                symbolColor = randomItemFromArray(SYMBOL_COLORS);
            }

            var symbol;
            if (noteLength === 1) {
                symbol = randomItemFromArray(BIG_SYMBOLS);
            } else if (noteLength === 0.5) {
                symbol = randomItemFromArray(MEDIUM_SYMBOLS);
            } else if (noteLength === 0.25) {
                symbol = randomItemFromArray(SMALL_SYMBOLS);
            }

            var verticalFlip = Math.random() < 0.5;
            var horizontalFlip = Math.random() < 0.5;

            if (verticalFlip) {
                symbol = flipSymbolVertically(symbol);
            }

            if (horizontalFlip) {
                symbol = flipSymbolHorizontally(symbol);
            }
            
            var alignment = Math.floor(Math.random() * 3); //0 = top, 1 = center, 2 = bottom

            if (symbolPositionIndex < LEFT_RIGHT_CUTOFF) { //on the left side we always align with the top
                alignment = 0;
            }

            var symbolHeight = symbol.length;
            var symbolY = 0;
            if (alignment === 0) {
                symbolY = 0;
            } else if (alignment === 1) {
                symbolY = (HEIGHT - symbolHeight) / 2;
            } else if (alignment === 2) {
                symbolY = HEIGHT - symbolHeight;
            }

            var yOffset = Math.floor(Math.random() * 4) - 2;
            symbolY += yOffset;

            var colorMultiplier = 1;

            //add symbol to sim
            for (var y = 0; y < symbol.length; ++y) {
                var row = symbol[y];
                for (var x = 0; x < row.length; ++x) {
                    var value = row[x];
                    setDataWithMax(this.dataArrayU, x + symbolX, y + symbolY, [symbolColor[0] * colorMultiplier * value * RIPPLE_SCALE, symbolColor[1] * colorMultiplier * value * RIPPLE_SCALE, symbolColor[2] * colorMultiplier * value * RIPPLE_SCALE]);
                    setDataWithMax(this.overlayDataArray, x + symbolX, y + symbolY, [symbolColor[0] * value * colorMultiplier, symbolColor[1] * value * colorMultiplier, symbolColor[2] * value * colorMultiplier]);
                }
            }
        }

        this.framesUntilNextSymbol -= 1;

        var velocityDissipation = MIN_VELOCITY_DISSIPATION + (Math.sin(time * 0.1) * 0.5 + 0.5) * (MAX_VELOCITY_DISSIPATION - MIN_VELOCITY_DISSIPATION);

        for (var y = 0; y < HEIGHT; ++y) {
            for (var x = 0; x < WIDTH; ++x) {
                var centerU = getData(this.dataArrayU, x, y, []);
                var leftU = getData(this.dataArrayU, x - 1, y, []);
                var rightU = getData(this.dataArrayU, x + 1, y, []);
                var topU = getData(this.dataArrayU, x, y + 1, []);
                var bottomU = getData(this.dataArrayU, x, y - 1, []);

                var centerV = getData(this.dataArrayV, x, y, []);

                var newV = [];
                var newU = [];

                var currentOverlay = getData(this.overlayDataArray, x, y, []);
                var newOverlay = [];

                for (var i = 0; i < 3; ++i) {
                    var force = RIPPLE_FORCE_SCALE * ((leftU[i] + rightU[i] + topU[i] + bottomU[i]) / 4 - centerU[i]); //compute force
                    newV[i] = centerV[i] + force;
                    newV[i] *= velocityDissipation;
                    newU[i] = (centerU[i] + newV[i]) * 0.99;
                    
                    newOverlay[i] = currentOverlay[i] * OVERLAY_FADE;
                }

                setData(this.overlayDataArray, x, y, newOverlay);

                setData(this.tempDataArrayU, x, y, newU);
                setData(this.dataArrayV, x, y, newV);
            }
        }

        var temp = this.dataArrayU;
        this.dataArrayU = this.tempDataArrayU;
        this.tempDataArrayU = temp;
    }

    p.render = function() {
        this.update();

        var frontImageData = this.frontCtx.createImageData(1,1);
        var sideImageData = this.sideCtx.createImageData(1, 1);

        this.frontCtx.fillStyle = 'black';
        this.frontCtx.fillRect(0, 0, this.frontCtx.canvas.width, this.frontCtx.canvas.height);

        this.sideCtx.fillStyle = 'black';
        this.sideCtx.fillRect(0, 0, this.sideCtx.canvas.width, this.sideCtx.canvas.height);

        var overlayRGB = [];
        var rgb = []; //cache

        for (var y = 0; y < HEIGHT; ++y) {
            for (var x = 0; x < WIDTH; ++x) {
                getData(this.overlayDataArray, x, y, overlayRGB);
                getData(this.dataArrayU, x, y, rgb);

                if (x < this.sideCtx.canvas.width) {
                    sideImageData.data[0] = rgb[0] + overlayRGB[0] * 1.25;
                    sideImageData.data[1] = rgb[1] + overlayRGB[1] * 1.25;
                    sideImageData.data[2] = rgb[2] + overlayRGB[2] * 1.25;
                    sideImageData.data[3] = 255;
                    this.sideCtx.putImageData(sideImageData, x, y);
                } else {
                    frontImageData.data[0] = rgb[0] + overlayRGB[0] * 1.25;
                    frontImageData.data[1] = rgb[1] + overlayRGB[1] * 1.25;
                    frontImageData.data[2] = rgb[2] + overlayRGB[2] * 1.25;
                    frontImageData.data[3] = 255;
                    this.frontCtx.putImageData(frontImageData, x - this.sideCtx.canvas.width, y);
                }
            }
        }
    };

    p.signal = function(channel, value) {
        // store beat values from channel 1
        if (channel == 1){
            this.currentBeatValue = value;
        }

        // store volume values from channel 2
        if (channel == 2){
            this.currentVolume = value;
        }
    };

module.exports = SymbolRipplesVisualiser;